name: gClock - Build and Release

permissions:
  contents: write
  issues: none

on:
  push:
    tags:
      - 'v*-raylib'

jobs:
  build-raylib-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install raylib dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config

          wget https://github.com/raysan5/raylib/releases/download/5.0/raylib-5.0_linux_amd64.tar.gz
          tar -xzf raylib-5.0_linux_amd64.tar.gz
          sudo cp -r raylib-5.0_linux_amd64/* /usr/local/

      - name: Build raylib project
        run: |
          mkdir -p build

          # Compile the project
          # The -s is for stripping the executable for a smaller size (optional)
          gcc -std=c99 -O2 -s \
          -I/usr/local/include \
          -L/usr/local/lib \
          src/main.c \
          -o build/gclock-linux \
          -lraylib -lm

      - uses: softprops/action-gh-release@v2
        with:
          name: gClock ${{ github.ref_name }}
          files: build/gclock-linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-raylib-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MSYS2
        shell: powershell
        run: |
          choco install -y msys2

      - name: Update PATH for MSYS2 Binaries
        shell: powershell
        run: |
          "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Raylib Dependencies
        shell: bash
        run: |
          bash.exe -lc "pacman -Sy --noconfirm"
          bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-raylib"

      - name: Build raylib project
        shell: bash
        env:
          PKG_CONFIG_PATH: /mingw64/lib/pkgconfig
        run: |
          mkdir -p build

          # Get CFLAGS and LDFLAGS for raylib using pkg-config
          CFLAGS="$(pkg-config --cflags raylib)"
          LDFLAGS="$(pkg-config --libs raylib)"

          echo "CFLAGS: $CFLAGS"
          echo "LDFLAGS: $LDFLAGS"

          # Compile the project
          # The -s is for stripping the executable for a smaller size (optional)
          x86_64-w64-mingw32-gcc -std=c99 -O2 -s \
           $CFLAGS \
           src/main.c \
           -o build/gclock.exe \
           $LDFLAGS \
           -lm

      - uses: softprops/action-gh-release@v2
        with:
          name: gClock ${{ github.ref_name }}
          files: build/gclock.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-raylib-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install raylib dependencies
        # Homebrew is the package manager for macOS runners
        run: |
          brew install raylib pkg-config

      - name: Build raylib project (macOS)
        run: |
          mkdir -p build

          # Use pkg-config to get CFLAGS and LDFLAGS for raylib
          CFLAGS="$(pkg-config --cflags raylib)"
          LDFLAGS="$(pkg-config --libs raylib)"

          echo "CFLAGS: $CFLAGS"
          echo "LDFLAGS: $LDFLAGS"

          # Compile the project
          gcc -std=c99 -O2 -s \
            $CFLAGS \
            src/main.c \
            -o build/gclock-macos \
            $LDFLAGS \
            -lm

      - uses: softprops/action-gh-release@v2
        with:
          name: gClock ${{ github.ref_name }}
          files: build/gclock-macos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
